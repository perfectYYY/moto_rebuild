
# 摩托车手套终端系统重构设计文档

**版本**: 1.0.1

## 1. 系统总体架构 (System Overview)
本系统采用 **主从式架构 (Master-Slave Architecture)**。
* **Host (终端)**: 基于 ESP32-S3，负责全局调度、人机交互、数据存储 (SD) 及传感器融合 (IMU/GNSS)。
* **Node (手套)**: 基于 STM32G03，负责高频温度采集、PID 闭环控制及执行器驱动。
* **Link (链路)**: UART (115200bps) 经由 CD4052 双路复用器进行时分多路通讯。

---

## 2. 通信协议规范 (Communication Protocol)
采用**二进制、定长/变长帧、请求-响应 (Request-Response)** 模式。详情见协议文档。

---

## 3. 终端 (ESP32-S3) 软件架构设计
采用 **组件化 (Component-Based)** 架构，严格遵循依赖倒置原则。

### 3.1 组件依赖关系图
* **App Layer (lib/App_*)**: 
    * `App_System`: 负责 `main` 组装、任务启动。
    * `App_Glove`: 仅依赖 `Kit_Core`，通过接口操作硬件。
    * `App_Storage`: 仅依赖 `Kit_Core`。
* **Interface Layer (lib/Kit_Core)**: 
    * 定义 `ITransport`, `IPacketHandler` 接口。
    * 定义 `ProtocolDef` 协议结构。
* **Driver Layer (lib/Driver_Hal)**: 
    * 实现 `UartTransport`, `SDStorageDriver`。
    * 直接调用 `Arduino.h` 或 `ESP-IDF`。

### 3.2 任务与核心分配 (Task & Core Affinity)
| Task Name | Core | Priority | Frequency | Description |
| :--- | :--- | :--- | :--- | :--- |
| **T_RealTime** | **1** | High (5) | 100Hz (10ms) | 负责全局 Tick、CD4052 切换、串口收发、IMU 解算。 |
| **T_Logging** | **0** | Low (2) | Event-Driven | 负责从队列读取数据并写入 SD 卡 (处理写卡阻塞)。 |
| **T_System** | **0** | Mid (3) | 10Hz | 负责 BLE 广播、屏幕刷新。 |

### 3.3 时序调度 (The Global Tick)
以 50ms (20Hz) 为一个完整通讯周期：
* **T+0ms**: 切左手套 (CD4052=L) -> 发送 Type 0x02 请求。
* **T+1~8ms**: 异步接收左手套回包 (Type 0x01) -> 解析 -> 更新 `GloveState` 快照。
* **T+10ms**: 切右手套 (CD4052=R) -> 发送 Type 0x02 请求。
* **T+11~18ms**: 异步接收右手套回包 -> 解析 -> 更新 `GloveState` 快照。
* **T+20ms**: 收集 IMU 数据、GNSS 数据、手套快照 -> 打包 -> `xQueueSend` 到存储任务。

## 4. 接口定义概览 (Interface Specs)

### 4.1 零成本日志 (Log.h)
采用宏定义实现，生产环境 (`LOG_LEVEL_NONE`) 编译后不占任何 Flash。

### 4.2 传输层接口 (ITransport.h)
```cpp
class ITransport {
public:
    using ReceiveCallback = std::function<void(const uint8_t* data, size_t len)>;
    virtual void init() = 0;
    virtual bool send(const uint8_t* data, size_t len) = 0;
    virtual void setReceiveCallback(ReceiveCallback cb) = 0;
};
```
## 5. 手套 (STM32G03) 优化方案
移除浮点与 Log: 删除 printf，移除 log() 和多项式计算。

NTC 查表法优化 (LUT): 预计算 256 点查表 + 线性插值，替代复杂数学运算。

影子寄存器: 使用 volatile 结构体接收串口中断数据，原子更新 PID 参数，避免计算竞态。