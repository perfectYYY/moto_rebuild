

# 单元测试策略与安全验证计划

**测试框架**: Unity (PlatformIO Native)

## 1. 测试策略：模拟优先 (Host-Based First)

鉴于 STM32G03 Flash 极小且烧录繁琐，**90% 的业务逻辑必须在 PC 端通过单元测试验证**。只有通过所有 Native 测试的代码才能合并到主分支。

### 1.1 桩 (Mock) 架构

通过实现 `ITransport` 接口的 Mock 版本，在 PC 上模拟串口收发。

```cpp
// MockTransport.h
class MockTransport : public ITransport {
public:
    std::vector<uint8_t> tx_buffer; // 捕获发送的数据
    
    bool send(const uint8_t* data, size_t len) override {
        tx_buffer.assign(data, data + len); // 记录发送，供断言检查
        return true;
    }
    
    // 模拟接收：测试用例调用此函数注入数据
    void injectRx(const uint8_t* data, size_t len) {
        if (callback_) callback_(data, len);
    }
};

```

## 2. 安全关键测试用例 (Safety Critical Test Cases)

**任何涉及 PID 计算和加热控制的代码修改，必须通过以下测试：**

| ID | 测试名称 | 输入条件 | 预期输出 | 依据 |
| --- | --- | --- | --- | --- |
| **TC-SAFE-01** | **NTC 断路保护** | 模拟 ADC 读数 = 4095 (3.3V) | PID 输出强制 = 0 | 防止 NTC 掉线导致无限加热 |
| **TC-SAFE-02** | **NTC 短路保护** | 模拟 ADC 读数 = 0 (0V) | PID 输出强制 = 0 | 防止电路故障 |
| **TC-SAFE-03** | **绝对过热熔断** | 模拟当前温度 > 55°C | PID 输出强制 = 0 | 即使 Target=60°C 也必须停机 |
| **TC-SAFE-04** | **通讯丢失故障** | 模拟 1000ms 未收到终端指令 | PID 输出强制 = 0 | 防止终端死机后手套失控 |
| **TC-SAFE-05** | **非数值注入** | 注入 NaN 或 Inf 到 PID 输入 | 系统不崩溃，输出 = 0 | 浮点运算健壮性 |

## 3. 协议稳健性测试

* **TC-PROT-01 (Fuzzing)**: 向 `PacketDispatcher` 注入 10,000 字节的随机噪声数据，验证系统不 Crash，且不误触发回调。
* **TC-PROT-02 (Truncation)**: 注入只有帧头没有 Payload 的数据，验证解析器是否正确复位等待。

## 4. 生产环境部署检查表 (Checklist)

在发布 Release 固件前，必须执行：

1. [ ] `platformio.ini` 中 `ACTIVE_LOG_LEVEL` 设为 `0` (NONE)。
2. [ ] 所有 `native` 单元测试通过 (Green)。
3. [ ] 静态代码分析 (Cppcheck) 无高危警告。
4. [ ] 检查 `ProtocolDef.h` 的结构体大小 (`sizeof`) 与 STM32 端一致。

