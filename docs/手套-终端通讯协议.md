
### 文档 3：手套-终端通讯协议
> **修改点**：明确了 **校验和算法 (Sum8)** 的具体实现，消除了歧义。

**文件名**: `docs/03_COMMUNICATION_PROTOCOL.md`

# 手套-终端通讯协议

**版本**: 1.0.1

## 一、 通讯基础配置
* **物理层**：UART (8-N-1)，波特率 115200 bps。
* **拓扑结构**：主从架构（终端 Master，手套 Slave）。
* **交互模式**：请求-响应（终端发一包，对应手套回一包）。
* **字节序**：小端模式（Little-Endian）。

---

## 二、 通用帧格式 (Frame Format)
所有数据包遵循以下对齐格式 (`__attribute__((packed))`)：

| Offset | Field | Type | Description |
| :--- | :--- | :--- | :--- |
| 0 | **HEAD** | `uint16_t` | 固定 `0xAA 0x55` |
| 2 | **TYPE** | `uint8_t` | `0x01`: Status (上报), `0x02`: Control (下发) |
| 3 | **LEN** | `uint8_t` | Payload 长度 |
| 4 | **PAYLOAD** | `uint8_t[]` | 业务数据 |
| 4+N | **CS** | `uint8_t` | Checksum (Sum8 算法) |

### 校验和算法 (Checksum Algorithm)
采用 **Sum8** (累加和自然溢出)。
**计算范围**: 从帧头第一个字节 (`0xAA`) 开始，直到 Payload 结束，**不包含 CS 本身**。

```cpp
uint8_t calculateChecksum(const uint8_t* data, size_t len) {
    uint8_t sum = 0;
    for(size_t i=0; i<len; i++) {
        sum += data[i]; // 让其自然溢出
    }
    return sum;
}

```

---

## 三、 业务载荷定义 (Payload Definition)

### 1. 状态上报帧 (Type: 0x01, Glove → Terminal)

**载荷长度：37 字节**

| 字段 | 类型 | 字节偏移 | 说明 |
| --- | --- | --- | --- |
| **Side ID** | `uint8_t` | 0 | `'L'` (0x4C) 或 `'R'` (0x52) |
| **Target Temp** | `uint8_t` | 1 | 设定温度 |
| **Current Temps** | `int16_t[7]` | 2-15 | 原始值 * 100 |
| **PWM Output** | `uint16_t[7]` | 16-29 | 0-1000 |
| **Voltage** | `uint16_t` | 30-31 | mV |
| **Current** | `uint16_t` | 32-33 | mA |
| **Power** | `uint16_t` | 34-35 | mW |
| **State Flag** | `uint8_t` | 36 | 状态位 |

### 2. 控制/参数下发帧 (Type: 0x02, Terminal → Glove)

**载荷长度：16 字节**

| 字段 | 类型 | 字节偏移 | 说明 |
| --- | --- | --- | --- |
| **Update Mask** | `uint8_t` | 0 | Bit0-6: PID更新使能, Bit7: 强制温度 |
| **Forced Temp** | `uint8_t` | 1 | 强制温度 (0=不覆盖) |
| **PID-Kp Array** | `uint8_t[7]` | 2-8 | Kp 参数 |
| **Power Limit** | `uint8_t[7]` | 9-15 | 功率限制 (0-255) |

```


