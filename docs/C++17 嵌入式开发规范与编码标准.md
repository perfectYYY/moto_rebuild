
# C++17 嵌入式开发规范与编码标准

**适用范围**: ESP32-S3 (Host)

## 1. 核心原则 (The Iron Rules)

1. **零成本抽象 (Zero-Cost Abstraction)**: 使用模板、`constexpr`、内联替代运行时开销。如果一个抽象导致汇编指令增加，它就是失败的。
2. **编译期安全**: 尽可能将错误暴露在编译阶段（使用 `static_assert`, `concepts`）。
3. **禁止动态内存**: 初始化后，严禁使用 `new`, `malloc`, `std::vector`。所有容器使用 `std::array` 或栈内存。
4. **禁止异常**: 编译器标志开启 `-fno-exceptions` 和 `-fno-rtti`。

## 2. 语法禁令 (Syntax Bans)

### 2.1 严禁 Switch-Case 语句

**原因**: 隐式 Fallthrough 风险、作用域混乱、分支预测性能不可控。
**替代方案**: 使用 **“查找表 (Lookup Table) + 多态/函数指针”**。

```cpp
// ❌ 禁止 (Bad)
void process(uint8_t type) {
    switch(type) {
        case 0x01: doA(); break; // 容易漏写 break
        case 0x02: doB(); break;
    }
}

// ✅ 推荐 (Good: C++17)
using HandlerFunc = void(*)(const uint8_t*);
constexpr std::array<HandlerFunc, 256> DispatchTable = []{
    std::array<HandlerFunc, 256> tbl{};
    tbl.fill(nullptr);
    tbl[0x01] = doA;
    tbl[0x02] = doB;
    return tbl;
}();

void process(uint8_t type) {
    if (DispatchTable[type]) DispatchTable[type](payload);
}

```

### 2.2 严禁 C 风格转换

**原因**: 破坏类型安全，难以搜索。
**替代方案**:

* `static_cast<T>()`: 用于算术类型转换。
* `reinterpret_cast<T>()`: 仅用于底层字节流序列化（如 `uint8_t*` 转 `Struct*`）。
* `const_cast`: 除非对接遗留 C 库，否则禁止使用。

### 2.3 严禁裸指针拥有资源

**原因**: 内存泄漏、悬垂指针。
**替代方案**: 指针仅作为“不拥有的观察者 (Non-owning observer)”传递。资源生命周期由栈对象或静态单例管理。

## 3. 现代 C++17 特性应用

### 3.1 `if constexpr` (编译期分支)

用于处理不同硬件差异，避免 `#ifdef` 宏地狱。

```cpp
template <typename T>
void hardware_init() {
    if constexpr (std::is_same_v<T, STM32>) {
        HAL_Init();
    } else {
        Arduino_Init();
    }
}

```

### 3.2 `[[nodiscard]]` (强制检查返回值)

对于涉及硬件操作的函数，必须标记。

```cpp
[[nodiscard]] bool sendPacket(const uint8_t* data);
// 如果调用者写 sendPacket(buf); 而不检查返回值，编译器会报错。

```

### 3.3 `enum class` (强类型枚举)

禁止使用 `enum`，防止命名空间污染和隐式整形转换。

```cpp
enum class GloveState : uint8_t {
    Idle = 0,
    Heating,
    Error
};
// 使用时必须显式：GloveState::Idle

```

## 4. 命名规范

* **类/结构体**: `PascalCase` (`GloveManager`)
* **函数/变量**: `camelCase` (`sendData`, `packetLen`)
* **私有成员**: `snake_case_` (`transport_`, `retry_count_`) —— **尾部下划线**区分成员变量。
* **常量/宏**: `UPPER_CASE` (`MAX_BUFFER_SIZE`)
